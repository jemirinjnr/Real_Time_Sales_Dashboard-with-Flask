<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Customer Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
</head>
<body>
    <h1>Customer Dashboard</h1>
    <form method="get" style="margin-bottom: 10px;">
        <label for="search">Search:</label>
        <span id="search-container"><input type="text" name="search" id="search" value="{{ search_query }}" placeholder="Search by product name"><button id="search-button" type="submit"><svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="16" height="16" viewBox="0,0,256,256"
style="fill:#FFFFFF;margin-top:1px;">
<g fill="#ffffff" fill-rule="nonzero" stroke="none" stroke-width="100" stroke-linecap="butt" stroke-linejoin="miter" stroke-miterlimit="10" stroke-dasharray="" stroke-dashoffset="0" font-family="none" font-weight="900" font-size="none" text-anchor="none" style="mix-blend-mode: normal"><g transform="scale(5.12,5.12)"><path d="M21,3c-9.37891,0 -17,7.62109 -17,17c0,9.37891 7.62109,17 17,17c3.71094,0 7.14063,-1.19531 9.9375,-3.21875l13.15625,13.125l2.8125,-2.8125l-13,-13.03125c2.55469,-2.97656 4.09375,-6.83984 4.09375,-11.0625c0,-9.37891 -7.62109,-17 -17,-17zM21,5c8.29688,0 15,6.70313 15,15c0,8.29688 -6.70312,15 -15,15c-8.29687,0 -15,-6.70312 -15,-15c0,-8.29687 6.70313,-15 15,-15z"></path></g></g>
</svg></button></span>  
    </form>
    <form method="get" style="margin-bottom: 10px;">
        <label for="category">Category:</label>
        <select name="category" id="category" onchange="this.form.submit()">
            <option value="">All</option>
            {% for cat in categories %}
                <option value="{{ cat }}" {% if cat == selected_category %}selected{% endif %}>{{ cat }}</option>
            {% endfor %}
        </select>
    </form>
    <div id="table-container">
        <table border="1">
            <thead>
                <tr>
                    {% for col in columns %}
                        <th>{{ col|title }}</th>
                    {% endfor %}
                    <th>Buy</th>
                </tr>
            </thead>
            <tbody id="product-table">
                {% include "table_customer.html" %}
            </tbody>
        </table>
        <div style="margin-top: 10px;" id="pagination-controls">
            Page {{ page }}
            {% set cleaned_category = selected_category | replace("&", "%26") | replace(" ", "%20") %}
            {% if page > 1 %}
                <a href="/dashboard/customer?page={{ page - 1 }}{% if selected_category %}&category={{ cleaned_category }}{% endif %}" style="margin-left: 10px;">Previous</a>
            {% endif %}
            {% if (page * per_page) < total %}
                <a href="/dashboard/customer?page={{ page + 1 }}{% if selected_category %}&category={{ cleaned_category }}{% endif %}" style="margin-left: 10px;">Next</a>
            {% endif %}
        </div>
    </div>
    <br><br>
    <button onclick="exitDashboard()">Exit</button>
    <script>
        function exitDashboard() {
            const confirmExit = confirm("Are you sure you want to exit?");
            if (confirmExit) {
                window.location.href = "/";
            }
        }
    </script>
    <script>
        function buy(name) {
            fetch('/buy', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ product_name: name })
            })
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.json();
            })
            .then(data => {
                if (!data.success) {
                    alert(data.error || 'Purchase failed');
                }
            })
            .catch((err) => alert('Network error: ' + err.message));
        }
        const socket = io();
        socket.on('update', () => {
            const params = new URLSearchParams(window.location.search);
            const page = params.get('page') || 1;
            const category = params.get('category') || '';
            const searchInput = document.getElementById('search');
            const search = searchInput?.value || '';

            fetch(`/dashboard/customer/table?page=${page}&category=${encodeURIComponent(category)}&search=${encodeURIComponent(search)}`)
                .then(res => res.text())
                .then(html => {
                    document.getElementById('product-table').innerHTML = html;

                    if (searchInput) searchInput.value = '';
                });

            const chart = document.getElementById('sales-chart');
            if (chart) chart.src = '/plot/sales?' + new Date().getTime();
        });
    </script>
</body>
</html>
